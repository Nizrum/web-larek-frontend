(()=>{"use strict";function isSelector(t){return"string"==typeof t&&t.length>1}function ensureElement(t,e){if(isSelector(t)){const r=function ensureAllElements(t,e=document){if(isSelector(t))return Array.from(e.querySelectorAll(t));if(t instanceof NodeList)return Array.from(t);if(Array.isArray(t))return t;throw new Error("Unknown selector element")}(t,e);if(r.length>1&&console.warn(`selector ${t} return more then one element`),0===r.length)throw new Error(`selector ${t} return nothing`);return r.pop()}if(t instanceof HTMLElement)return t;throw new Error("Unknown selector element")}function cloneTemplate(t){return ensureElement(t).content.firstElementChild.cloneNode(!0)}function setElementData(t,e){for(const r in e)t.dataset[r]=String(e[r])}function isPlainObject(t){const e=Object.getPrototypeOf(t);return e===Object.getPrototypeOf({})||null===e}class Api{constructor(t,e={}){var r;this.baseUrl=t,this.options={headers:Object.assign({"Content-Type":"application/json"},null!==(r=e.headers)&&void 0!==r?r:{})}}handleResponse(t){return t.ok?t.json():t.json().then((e=>{var r;return Promise.reject(null!==(r=e.error)&&void 0!==r?r:t.statusText)}))}get(t){return fetch(this.baseUrl+t,Object.assign(Object.assign({},this.options),{method:"GET"})).then(this.handleResponse)}post(t,e,r="POST"){return fetch(this.baseUrl+t,Object.assign(Object.assign({},this.options),{method:r,body:JSON.stringify(e)})).then(this.handleResponse)}}class CardView{constructor(t,e,r){this.events=e,this._colors={дополнительное:"additional","софт-скил":"soft",кнопка:"button","хард-скил":"hard",другое:"other"},this.cardElement=cloneTemplate(t),this.cardCategory=this.cardElement.querySelector(".card__category"),this.cardTitle=this.cardElement.querySelector(".card__title"),this.cardImage=this.cardElement.querySelector(".card__image"),this.cardPrice=this.cardElement.querySelector(".card__price"),r&&this.cardElement.addEventListener("click",r)}getPriceText(t){return null===t?"Бесценно":String(t)+" синапсов"}render(t){return this.cardCategory.textContent=t.category,this.cardCategory.className=`card__category card__category_${this._colors[t.category]}`,this.cardTitle.textContent=t.title,this.cardImage.src=t.image,this.cardImage.alt=this.cardTitle.textContent,this.cardPrice.textContent=this.getPriceText(t.price),this.cardElement}}class CardModalView extends CardView{constructor(t,e,r){super(t,e,r),this.events=e,this.description=this.cardElement.querySelector(".card__text"),this.button=this.cardElement.querySelector(".card__button"),this.button.addEventListener("click",(()=>{this.events.emit("card:addToCart")}))}toggleButtonDisability(t){t?this.button.setAttribute("disabled","true"):this.button.removeAttribute("disabled")}render(t){return super.render(t),this.description.textContent=t.description,t.price||this.button.setAttribute("disabled","true"),this.cardElement}}class CartItemView{constructor(t,e,r){this.events=e,this.cartItem=cloneTemplate(t),this.index=this.cartItem.querySelector(".basket__item-index"),this.title=this.cartItem.querySelector(".card__title"),this.price=this.cartItem.querySelector(".card__price"),this.deleteButton=this.cartItem.querySelector(".basket__item-delete"),r&&this.deleteButton.addEventListener("click",r)}getPriceText(t){return null===t?"Бесценно":String(t)+" синапсов"}render(t,e){return this.index.textContent=String(e),this.title.textContent=t.title,this.price.textContent=this.getPriceText(t.price),this.cartItem}}class SuccessfulOrderView{constructor(t,e){this.events=e,this.modal=cloneTemplate(t),this.description=this.modal.querySelector(".order-success__description"),this.button=this.modal.querySelector(".order-success__close"),this.button.addEventListener("click",(()=>{e.emit("successfulOrder:close")}))}render(t){return this.description.textContent=String(`Списано ${t} синапсов`),this.modal}}const t=ensureElement("#modal-container"),e=ensureElement("#card-catalog"),r=ensureElement("#card-preview"),s=ensureElement("#basket"),n=ensureElement("#card-basket"),o=ensureElement("#order"),i=ensureElement("#contacts"),a=ensureElement("#success"),c=ensureElement(".gallery"),l=new class ApiModel extends Api{constructor(t,e,r){super(e,r),this.resourcesUrl=t}fetchProducts(){return this.get("/product").then((t=>t.items.map((t=>Object.assign(Object.assign({},t),{image:this.resourcesUrl+t.image})))))}getOrderResult(t){return this.post("/order",t).then((t=>t))}}("/content/weblarek","/api/weblarek"),d=new class EventEmitter{constructor(){this._events=new Map}on(t,e){var r;this._events.has(t)||this._events.set(t,new Set),null===(r=this._events.get(t))||void 0===r||r.add(e)}off(t,e){var r;this._events.has(t)&&(this._events.get(t).delete(e),0===(null===(r=this._events.get(t))||void 0===r?void 0:r.size)&&this._events.delete(t))}emit(t,e){this._events.forEach(((r,s)=>{"*"===s&&r.forEach((r=>r({eventName:t,data:e}))),(s instanceof RegExp&&s.test(t)||s===t)&&r.forEach((t=>t(e)))}))}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(r={})=>{this.emit(t,Object.assign(Object.assign({},r||{}),e||{}))}}},h=new class ProductListModel{constructor(t){this.events=t,this._productCards=[]}set productCards(t){this._productCards=t,this.events.emit("products:set")}get productCards(){return this._productCards}showCard(t){this.selectedСard=t,this.events.emit("cardModal:open",t)}}(d),u=new class ModalView{constructor(t,e){this.events=e,this._modalContainer=t,this._closeButton=t.querySelector(".modal__close"),this._content=t.querySelector(".modal__content"),this._pageWrapper=document.querySelector(".page__wrapper"),this._closeButton.addEventListener("click",this.close.bind(this)),this._modalContainer.addEventListener("click",this.close.bind(this)),this._modalContainer.querySelector(".modal__container").addEventListener("click",(t=>t.stopPropagation()))}set content(t){this._content.replaceChildren(t)}open(){this._modalContainer.classList.add("modal_active"),this.events.emit("modal:open")}close(){this._modalContainer.classList.remove("modal_active"),this.content=null,this.events.emit("modal:close")}set locked(t){t?this._pageWrapper.classList.add("page__wrapper_locked"):this._pageWrapper.classList.remove("page__wrapper_locked")}}(t,d),m=new class CartView{constructor(t,e,r){this.events=e,this.cartItemTemplate=r,this.cart=cloneTemplate(t),this.title=this.cart.querySelector(".modal__title"),this.cartList=this.cart.querySelector(".basket__list"),this.button=this.cart.querySelector(".basket__button"),this.cartTotalPrice=this.cart.querySelector(".basket__price"),this.headerCartButton=document.querySelector(".header__basket"),this.headerCartCounter=document.querySelector(".header__basket-counter"),this.button.addEventListener("click",(()=>{this.events.emit("orderForm:open")})),this.headerCartButton.addEventListener("click",(()=>{this.events.emit("cart:open")})),this.items=[]}renderItems(t){let e=0;this.items=t.map((t=>{const r=new CartItemView(this.cartItemTemplate,this.events,(()=>this.events.emit("cart:removeFromCart",t)));return e+=1,r.render(t,e)})),this.items.length?(this.cartList.replaceChildren(...this.items),this.button.removeAttribute("disabled")):(this.button.setAttribute("disabled","true"),this.cartList.replaceChildren(function createElement(t,e,r){const s=document.createElement(t);if(e)for(const t in e){const r=e[t];isPlainObject(r)&&"dataset"===t?setElementData(s,r):s[t]="boolean"==typeof r?r:String(r)}if(r)for(const t of Array.isArray(r)?r:[r])s.append(t);return s}("p",{textContent:"Корзина пуста"})))}renderHeaderCartCounter(t){this.headerCartCounter.textContent=String(t)}renderTotalCost(t){this.cartTotalPrice.textContent=String(t+" синапсов")}render(){return this.title.textContent="Корзина",this.cart}}(s,d,n),p=new class CartModel{constructor(){this._cartProducts=new Set}set cartProducts(t){this._cartProducts=new Set(t)}get cartProducts(){return Array.from(this._cartProducts)}getAmount(){return this.cartProducts.length}getTotalCost(){return this.cartProducts.reduce(((t,e)=>t+e.price),0)}addToCart(t){this._cartProducts.add(t)}deleteFromCart(t){this._cartProducts.delete(t)}clearCart(){this.cartProducts=[]}},g=new class FormModel{constructor(t){this.events=t,this.formErrors={},this.payment="",this.email="",this.phone="",this.address="",this.total=0,this.items=[]}setOrderData(t,e){"address"===t?this.address=e:"email"===t?this.email=e:"phone"===t&&(this.phone=e),this.validateOrder(t)&&this.events.emit("order:valid",this.getOrderData())}validateOrder(t){const e={};return this.address?this.payment?this.email?this.phone||(e.phone="Необходимо указать телефон"):e.email="Необходимо указать email":e.payment="Выберите способ оплаты":e.address="Необходимо указать адрес",this.formErrors=e,"address"==t||"payment"==t?this.events.emit("formErrors:shipping",this.formErrors):"email"!=t&&"phone"!=t||this.events.emit("formErrors:contacts",this.formErrors),0===Object.keys(e).length}getOrderData(){return{payment:this.payment,email:this.email,phone:this.phone,address:this.address,total:this.total,items:this.items}}}(d),_=new class OrderFormView{constructor(t,e){this.events=e,this.form=cloneTemplate(t),this.paymentOptionsButtons=Array.from(this.form.querySelectorAll(".button_alt")),this.buttonSubmit=this.form.querySelector(".order__button"),this.formErrors=this.form.querySelector(".form__errors"),this.paymentOptionsButtons.forEach((t=>{t.addEventListener("click",(()=>{this.selectPaymentMethod(t.name),e.emit("orderForm:paymentSelection",t)}))})),this.form.addEventListener("input",(t=>{const e=t.target,r=e.name,s=e.value;this.events.emit("orderForm:changeAddress",{field:r,value:s})})),this.form.addEventListener("submit",(t=>{t.preventDefault(),this.events.emit("contactsForm:open")}))}selectPaymentMethod(t){this.paymentOptionsButtons.forEach((e=>{e.classList.toggle("button_alt-active",e.name===t)}))}toggleButtonDisability(t){this.buttonSubmit.disabled=!t}render(){return this.form}}(o,d),f=new class ContactsFormView{constructor(t,e){this.events=e,this.form=cloneTemplate(t),this.contactsInputs=Array.from(this.form.querySelectorAll(".form__input")),this.submitButton=this.form.querySelector(".button"),this.formErrors=this.form.querySelector(".form__errors"),this.contactsInputs.forEach((t=>{t.addEventListener("input",(t=>{const e=t.target,r=e.name,s=e.value;this.events.emit("contactsForm:changeContacts",{field:r,value:s})}))})),this.form.addEventListener("submit",(t=>{t.preventDefault(),this.events.emit("successfulOrder:open")}))}toggleButtonDisability(t){this.submitButton.disabled=!t}render(){return this.form}}(i,d),v=new class CardListView{constructor(t,e,r){this.catalogElement=t,this.events=e,this.catalogCardTemplate=r}render(t){return t.forEach((t=>{const e=new CardView(this.catalogCardTemplate,this.events,(()=>this.events.emit("card:select",t)));this.catalogElement.append(e.render(t))})),this.catalogElement}}(c,d,e);d.on("products:set",(()=>{v.render(h.productCards)})),d.on("card:select",(t=>{h.showCard(t)})),d.on("cardModal:open",(t=>{const e=new CardModalView(r,d);u.content=e.render(t),-1!==p.cartProducts.indexOf(t)||null==t.price?e.toggleButtonDisability(!0):e.toggleButtonDisability(!1),u.open()})),d.on("card:addToCart",(()=>{p.addToCart(h.selectedСard),m.renderHeaderCartCounter(p.getAmount()),u.close()})),d.on("cart:open",(()=>{m.renderTotalCost(p.getTotalCost()),m.renderItems(p.cartProducts),u.content=m.render(),u.open()})),d.on("cart:removeFromCart",(t=>{p.deleteFromCart(t),m.renderHeaderCartCounter(p.getAmount()),m.renderTotalCost(p.getTotalCost()),m.renderItems(p.cartProducts)})),d.on("orderForm:open",(()=>{u.content=_.render(),u.open(),g.items=p.cartProducts.map((t=>t.id))})),d.on("orderForm:paymentSelection",(t=>{g.payment=t.name,g.validateOrder("payment")})),d.on("orderForm:changeAddress",(t=>{g.setOrderData(t.field,t.value)})),d.on("formErrors:shipping",(t=>{const{address:e,payment:r}=t;_.toggleButtonDisability(!e&&!r),_.formErrors.textContent=Object.values({address:e,payment:r}).filter((t=>!!t)).join("; ")})),d.on("contactsForm:open",(()=>{g.total=p.getTotalCost(),u.content=f.render(),u.open()})),d.on("contactsForm:changeContacts",(t=>{g.setOrderData(t.field,t.value)})),d.on("formErrors:contacts",(t=>{const{email:e,phone:r}=t;f.toggleButtonDisability(!e&&!r),f.formErrors.textContent=Object.values({phone:r,email:e}).filter((t=>!!t)).join("; ")})),d.on("successfulOrder:open",(()=>{l.getOrderResult(g.getOrderData()).then((t=>{console.log(t);const e=new SuccessfulOrderView(a,d);u.content=e.render(p.getTotalCost()),p.clearCart(),m.renderHeaderCartCounter(p.getAmount()),u.open()})).catch((t=>console.log(t)))})),d.on("successfulOrder:close",(()=>u.close())),d.on("modal:open",(()=>{u.locked=!0})),d.on("modal:close",(()=>{u.locked=!1})),l.fetchProducts().then((function(t){h.productCards=t})).catch((t=>console.log(t)))})();
//# sourceMappingURL=main.js.map